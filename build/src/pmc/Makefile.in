## $Id$

# values from parrot_config
VERSION_DIR   = @versiondir@
INCLUDE_DIR   = @includedir@$(VERSION_DIR)
LIB_DIR       = @libdir@$(VERSION_DIR)
SRC_DIR       = @srcdir@$(VERSION_DIR)
TOOLS_DIR     = @libdir@$(VERSION_DIR)/tools/lib
STAGING_DIR   = dynext
#INSTALL_DIR   = $(LIB_DIR)/languages/blizkost/dynext
INSTALL_DIR   = $(LIB_DIR)/dynext

# Set up extensions
LOAD_EXT      = @load_ext@
O             = @o@

# Setup some commands
PERL          = @p5_perl@
RM_F          = @rm_f@
MKPATH        = @mkpath@
CHMOD         = @chmod@
CP            = @cp@
CC            = @cc@ -c
LD            = @ld@
LDFLAGS       = @ldflags@ @ld_debug@ @libs@
LD_LOAD_FLAGS = @ld_load_flags@
CFLAGS        = @ccflags@ @cc_shared@ @cc_debug@ @ccwarn@ @cc_hasjit@ @cg_flag@ @gc_flag@ @p5_ccopts@
CC_OUT        = @cc_o_out@
LD_OUT        = @ld_out@
LIBPARROT     = @inst_libparrot_ldflags@

PMC2C_INCLUDES  = --include $(SRC_DIR) --include $(SRC_DIR)/pmc
PMC2C           = $(PERL) $(LIB_DIR)/tools/build/pmc2c.pl
PMC2CD          = $(PMC2C) --dump $(PMC2C_INCLUDES)
PMC2CC          = $(PMC2C) -c $(PMC2C_INCLUDES)

INCLUDES        = -I$(INCLUDE_DIR) -I$(INCLUDE_DIR)/pmc
LINKARGS        = $(LDFLAGS) $(LD_LOAD_FLAGS) $(LIBPARROT) @p5_ldopts@

PMC_BLIZKOST_GROUP = blizkost_group

PMC_SOURCES = \
  src/pmc/p5sv.pmc \
  src/pmc/p5interpreter.pmc \
  src/pmc/p5scalar.pmc \
  src/pmc/p5hashiter.pmc \
  src/pmc/p5namespace.pmc \
  src/pmc/p5invocation.pmc

PMC_C = $(PMC_SOURCES:.pmc=.c)
PMC_DUMP = $(PMC_SOURCES:.pmc=.dump)

OBJS = \
  src/pmc/lib-$(PMC_BLIZKOST_GROUP)$(O) \
  src/pmc/bkmarshal$(O) \
  $(PMC_SOURCES:.pmc=@o@)

CLEANUPS = \
  "src/pmc/*$(LOAD_EXT)" \
  "src/pmc/*$(O)" \
  "src/pmc/p5*.c" \
  "src/pmc/pmc*.h" \
  "src/pmc/*.dump" \
#IF(win32):  "src/pmc/*.exp" \
#IF(win32):  "src/pmc/*.ilk" \
#IF(win32):  "src/pmc/*.manifext" \
#IF(win32):  "src/pmc/*.pdb" \
#IF(win32):  "src/pmc/*.lib" \
  $(STAGING_DIR)/$(PMC_BLIZKOST_GROUP)$(LOAD_EXT)

pmc_all: pmc_staging

src/pmc/init_with_xs.h:
	$(PERL) -MExtUtils::Embed -e xsinit -- -o src/pmc/init_with_xs.h

.SUFFIXES : .pmc .dump

.pmc.dump:
	$(PMC2C) --no-lines --dump $(PMC2C_INCLUDES) $<
.pmc.c:
	$(PMC2C) --no-lines -c $(PMC2C_INCLUDES) $<

pmc_generate: src/pmc/init_with_xs.h $(PMC_SOURCES) $(PMC_DUMP) $(PMC_C)
	$(PMC2C) --no-lines --library $(PMC_BLIZKOST_GROUP) -c $(PMC_SOURCES)

pmc_compile: pmc_generate
	$(CC) $(CC_OUT)src/pmc/p5sv$(O)  $(INCLUDES) $(CFLAGS) src/pmc/p5sv.c
	$(CC) $(CC_OUT)src/pmc/p5scalar$(O)  $(INCLUDES) $(CFLAGS) src/pmc/p5scalar.c
	$(CC) $(CC_OUT)src/pmc/p5namespace$(O)  $(INCLUDES) $(CFLAGS) src/pmc/p5namespace.c
	$(CC) $(CC_OUT)src/pmc/p5interpreter$(O) $(INCLUDES) $(CFLAGS) src/pmc/p5interpreter.c
	$(CC) $(CC_OUT)src/pmc/p5invocation$(O) $(INCLUDES) $(CFLAGS) src/pmc/p5invocation.c
	$(CC) $(CC_OUT)src/pmc/p5hashiter$(O) $(INCLUDES) $(CFLAGS) src/pmc/p5hashiter.c
	$(CC) $(CC_OUT)src/pmc/lib-$(PMC_BLIZKOST_GROUP)$(O) $(INCLUDES) $(CFLAGS) src/pmc/$(PMC_BLIZKOST_GROUP).c
	$(CC) $(CC_OUT)src/pmc/bkmarshal$(O) $(INCLUDES) $(CFLAGS) src/pmc/bkmarshal.c

pmc_linklibs: pmc_compile
	$(LD) $(LD_OUT)src/pmc/$(PMC_BLIZKOST_GROUP)$(LOAD_EXT) $(OBJS) $(LINKARGS)

pmc_staging: pmc_linklibs
#IF(cygwin):	CHMOD 0775 "src/pmc/*$(LOAD_EXT)"
#IF(hpux):	CHMOD 0775 "src/pmc/*$(LOAD_EXT)"
	$(CP) "src/pmc/*$(LOAD_EXT)" $(STAGING_DIR)

pmc_install:
#IF(cygwin):	CHMOD 0775 "src/pmc/*$(LOAD_EXT)"
#IF(hpux):	CHMOD 0775 "src/pmc/*$(LOAD_EXT)"
	$(MKPATH) $(INSTALL_DIR)
	$(CP) "src/pmc/*$(LOAD_EXT)" $(INSTALL_DIR)

pmc_uninstall:
	$(RM_F) $(INSTALL_DIR)/$(PMC_BLIZKOST_GROUP)$(LOAD_EXT)

src/pmc/Makefile: build/src/pmc/Makefile.in
	$(PERL) Configure.pl

pmc_clean:
	$(RM_F) $(CLEANUPS)

pmc_realclean:
	$(RM_F) $(CLEANUPS) src/pmc/Makefile

# Local variables:
#   mode: makefile
# End:
# vim: ft=make:

